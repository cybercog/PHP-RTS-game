var highlight1 = L.icon({
    iconUrl: '/img/map/tiles/highlight.png',

    iconSize: [9, 9], // size of the icon

    iconAnchor: [4.5, 4.5] // point of the icon which will correspond to marker's location
    //popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
});

var highlight2 = L.icon({
    iconUrl: '/img/map/tiles/highlight.png',

    iconSize: [18, 18], // size of the icon

    iconAnchor: [9, 9] // point of the icon which will correspond to marker's location
    //popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
});

var highlight3 = L.icon({
    iconUrl: '/img/map/tiles/highlight.png',

    iconSize: [36, 36], // size of the icon

    iconAnchor: [18, 18] // point of the icon which will correspond to marker's location
    //popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
});

var highlight4 = L.icon({
    iconUrl: '/img/map/tiles/highlight.png',

    iconSize: [72, 72], // size of the icon

    iconAnchor: [36, 36] // point of the icon which will correspond to marker's location
    //popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
});


var city1 = L.icon({
    iconUrl: '/img/map/tiles/city.png',

    iconSize: [9, 9], // size of the icon

    iconAnchor: [4.5, 4.5] // point of the icon which will correspond to marker's location
    //popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
});

var city2 = L.icon({
    iconUrl: '/img/map/tiles/city.png',

    iconSize: [18, 18], // size of the icon

    iconAnchor: [9, 9] // point of the icon which will correspond to marker's location
    //popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
});

var city3 = L.icon({
    iconUrl: '/img/map/tiles/city.png',

    iconSize: [36, 36], // size of the icon

    iconAnchor: [18, 18] // point of the icon which will correspond to marker's location
    //popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
});

var city4 = L.icon({
    iconUrl: '/img/map/tiles/city.png',

    iconSize: [72, 72], // size of the icon

    iconAnchor: [36, 36] // point of the icon which will correspond to marker's location
    //popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
});


var army1 = L.icon({
    iconUrl: '/img/map/tiles/army.png',

    iconSize: [9, 9], // size of the icon

    iconAnchor: [4.5, 4.5] // point of the icon which will correspond to marker's location
    //popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
});

var army2 = L.icon({
    iconUrl: '/img/map/tiles/army.png',

    iconSize: [18, 18], // size of the icon

    iconAnchor: [9, 9] // point of the icon which will correspond to marker's location
    //popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
});

var army3 = L.icon({
    iconUrl: '/img/map/tiles/army.png',

    iconSize: [36, 36], // size of the icon

    iconAnchor: [18, 18] // point of the icon which will correspond to marker's location
    //popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
});

var army4 = L.icon({
    iconUrl: '/img/map/tiles/army.png',

    iconSize: [72, 72], // size of the icon

    iconAnchor: [36, 36] // point of the icon which will correspond to marker's location
    //popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
});


var green1 = L.icon({
    iconUrl: '/img/map/tiles/green.png',

    iconSize: [9, 9], // size of the icon

    iconAnchor: [4.5, 4.5] // point of the icon which will correspond to marker's location
    //popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
});

var green2 = L.icon({
    iconUrl: '/img/map/tiles/green.png',

    iconSize: [18, 18], // size of the icon

    iconAnchor: [9, 9] // point of the icon which will correspond to marker's location
    //popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
});

var green3 = L.icon({
    iconUrl: '/img/map/tiles/green.png',

    iconSize: [36, 36], // size of the icon

    iconAnchor: [18, 18] // point of the icon which will correspond to marker's location
    //popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
});

var green4 = L.icon({
    iconUrl: '/img/map/tiles/green.png',

    iconSize: [72, 72], // size of the icon

    iconAnchor: [36, 36] // point of the icon which will correspond to marker's location
    //popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
});


var brush1 = L.icon({
    iconUrl: '/img/map/tiles/brush.png',

    iconSize: [9, 9], // size of the icon

    iconAnchor: [4.5, 4.5] // point of the icon which will correspond to marker's location
    //popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
});

var brush2 = L.icon({
    iconUrl: '/img/map/tiles/brush.png',

    iconSize: [18, 18], // size of the icon

    iconAnchor: [9, 9] // point of the icon which will correspond to marker's location
    //popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
});

var brush3 = L.icon({
    iconUrl: '/img/map/tiles/brush.png',

    iconSize: [36, 36], // size of the icon

    iconAnchor: [18, 18] // point of the icon which will correspond to marker's location
    //popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
});

var brush4 = L.icon({
    iconUrl: '/img/map/tiles/brush.png',

    iconSize: [72, 72], // size of the icon

    iconAnchor: [36, 36] // point of the icon which will correspond to marker's location
    //popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
});


// some constants
var margin_x = 27;
var margin_y = 36;
var HEX_HEIGHT = 72;
var HEX_SCALED_HEIGHT = HEX_HEIGHT;
var HEX_SIDE = HEX_SCALED_HEIGHT / 2;
var firstLoad = true;

var cities_zindex = 1000;
var armies_zindex = 5000;
var path_point_zindex = 4000;
var path_zindex = 3000;
var highlight_zindex = 2000;


$.ajaxSetup({
    headers: {'X-CSRF-Token': $('meta[name=csrf_token]').attr('content')}
});

function offsetToCube(hex) {
    var x = hex.x;
    var z = hex.y - (hex.x - (hex.x & 1)) / 2;
    var y = -x - z;

    return {x: x, y: y, z: z};
}

function cubeToOffset(hex) {
    var x = hex.x;
    var y = hex.z + (hex.x - (hex.x & 1)) / 2;
    return {x: x, y: y};
}

function cubeDistance(a, b) {
    return (Math.abs(a.x - b.x) + Math.abs(a.y - b.y) + Math.abs(a.z - b.z)) / 2;
}

function cubeLerp(a, b, t) {
    return {
        x: (a.x + (b.x - a.x) * t),
        y: (a.y + (b.y - a.y) * t),
        z: (a.z + (b.z - a.z) * t)
    }
}

function calculateLine(a, b) {
    var N = cubeDistance(a, b);
    var results = [];
    for (var i = 0; i < N; i++) {
        results.push(cubeToOffset(cubeRound(cubeLerp(a, b, 1.0 / N * i))));
    }
    return results;
}

function cubeRound(h) {
    var rx = Math.round(h.x);
    var ry = Math.round(h.y);
    var rz = Math.round(h.z);

    var x_diff = Math.abs(rx - h.x);
    var y_diff = Math.abs(ry - h.y);
    var z_diff = Math.abs(rz - h.z);

    if (x_diff > y_diff && x_diff > z_diff) {
        rx = -ry - rz
    } else if (y_diff > z_diff) {
        ry = -rx - rz
    } else {
        rz = -rx - ry
    }

    return {x: rx, y: ry, z: rz}
}


//#############################################################################################
//#############################################################################################
//#############################################################################################








function init() {
    var mapMinZoom = 1;
    var mapMaxZoom = 4;

    var img = [
        2231,  // original width of image
        2988   // original height of image
    ];
    map = L.map('map', {
        maxZoom: mapMaxZoom,
        minZoom: mapMinZoom,
        crs: L.CRS.Simple,
        contextmenu: true,
        contextmenuItems: [{
            text: 'pont hozzáadása az útvonalhoz',
            callback: addPathPoint,
            disabled: true
        }]
    }).setView([0, 0], mapMinZoom);

    city_markers = L.layerGroup().addTo(map);
    army_markers = L.layerGroup().addTo(map);
    path_markers = L.layerGroup().addTo(map);
    point_markers = L.layerGroup().addTo(map);
    started_path_group = L.layerGroup().addTo(map);

    rc = new L.RasterCoords(map, img);

    var mapBounds = new L.LatLngBounds(
        map.unproject([0, 3000], mapMaxZoom),
        map.unproject([3000, 0], mapMaxZoom));

    map.fitBounds(mapBounds);

    L.tileLayer('http://localhost/img/map/{z}/{x}/{y}.png', {
        minZoom: mapMinZoom,
        maxZoom: mapMaxZoom,
        continuousWorld: true,
        bounds: mapBounds,
        noWrap: true
        //tms: false
    }).addTo(map);

    // minimap =======================================================================
    var minimap = new L.TileLayer('/img/map/{z}/{x}/{y}.png', {
        minZoom: 0,
        maxZoom: mapMaxZoom,
        continuousWorld: true,
        bounds: mapBounds
    });

    new L.Control.MiniMap(minimap, {
        toggleDisplay: true,
        height: 200,
        position: 'bottomleft'
    }).addTo(map);

    map.panBy([1, 0]);

    $.ajaxSetup({cache: false});

    getCities();

    getArmies();

    // info box ===========================================================================
    info = L.control();
    info.onAdd = function (map) {
        this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
        this.update();
        return this._div;
    };

    // method that we will use to update the control based on feature properties passed
    info.update = function (data) {
        if (data) {
            var info = '<b>Koordináták</b><br>' +
                '<b>x: </b>' + data.x + '<br>' +
                '<b>y: </b>' + data.y +
                (data.city_name ? '' : '<br>' +
                '<b>Típus: </b>' + data.type +
                (data.hex_owner ? '<br>' +
                '<b>Tulajdonos: </b>' + data.hex_owner : ''));

            if (data.city_name) {
                info += '<br><br> <b>Város</b><br> ' +
                    '<b>Név:</b> ' + data.city_name + '<br>' +
                    '<b>Tulajdonos:</b> ' + data.city_owner + '<br>' +
                    '<b>Nép: </b>' + data.city_nation;
            }
            if (data.army_id) {
                info += '<br><br> <b>Hadsereg</b><br>' +
                    (data.army_owner ? ' <b>Tulajdonos:</b> ' + data.army_owner : "") +
                    (data.army_nation ? '<br><b>Nép:</b> ' + data.army_nation : '');
            }
            if (typeof data.army != 'undefined') {
                    info += '<br><b>Egységek</b><br>' +
                        'könnyűgyalogos: ' + data.army.unit1 + '<br>' +
                        'nehézgyalogos: ' + data.army.unit2 + '<br>' +
                        'pikás: ' + data.army.unit3 + '<br>' +
                        'könnyűlovas: ' + data.army.unit4 + '<br>' +
                        'nehézlovas: ' + data.army.unit5 + '<br>' +
                        'íjász: ' + data.army.unit6 + '<br>' +
                        'katapult: ' + data.army.unit7;
                }

        }
        this._div.innerHTML = '<h4>Információk</h4>' + (data ? info : 'Jelölj ki egy hexet');
    };
    info.addTo(map);

    map.on('click', onMapClick);

    map.on('contextmenu.show', function (e) {
        var coord = calculateHexCoord(e.contextmenu._showLocation.latlng);
        placeHighlightHex(coord.x, coord.y);
        getHexData(coord.x, coord.y);
        rightClicked = e.relatedTarget;
    });

    // zoom adjusting ===================================================================
    map.on('zoomend', function () {

        city_markers.eachLayer(function (layer) {
            layer.setIcon(window["city" + map.getZoom()]);
        });

        army_markers.eachLayer(function (layer) {
            layer.setIcon(window["army" + map.getZoom()]);
        });

        path_markers.eachLayer(function (layer) {
            layer.setIcon(window["brush" + map.getZoom()]);
        });

        started_path_group.eachLayer(function (layer) {
            layer.setIcon(window["brush" + map.getZoom()]);
        });

        point_markers.eachLayer(function (layer) {
            layer.setIcon(window["green" + map.getZoom()]);
        });

        if (typeof highlightMarker != 'undefined') {
            highlightMarker.setIcon(window["highlight" + map.getZoom()]);
        }

        if (typeof highlightMarkerFrom != 'undefined') {
            highlightMarkerFrom.setIcon(window["highlight" + map.getZoom()]);
        }


    });
}

function getCities() {
    $.getJSON("/map/get_cities", function (data) {
        for (var i in data) {
            tx = (data[i].x * HEX_SIDE * 1.5) + 36;
            ty = (data[i].y * HEX_SCALED_HEIGHT + (data[i].x % 2) * HEX_SCALED_HEIGHT / 2) + 36;

            city_marker = L.marker(rc.unproject([tx + margin_x, ty + margin_y]), {
                icon: window["city" + map.getZoom()],
                zIndexOffset: cities_zindex,
                clickable: false
            }).addTo(map);
            city_markers.addLayer(city_marker);
        }
    }).complete(function () {
        if (start_coord != 0) {
            placeHighlightHex(start_coord[0], start_coord[1]);
            getHexData(start_coord[0], start_coord[1]);
            map.setView(highlightMarker.getLatLng(), 4);
        }
        if (firstLoad == true) {
            map.fitBounds(map.getBounds());
            firstLoad = false;
        }
    });

}

function getArmies() {
    $.getJSON("/map/get_armies", function (data) {
        for (var i in data) {
            tx = (data[i].x * HEX_SIDE * 1.5) + 36;
            ty = (data[i].y * HEX_SCALED_HEIGHT + (data[i].x % 2) * HEX_SCALED_HEIGHT / 2) + 36;

            var army_marker = L.marker(rc.unproject([tx + margin_x, ty + margin_y]), {
                icon: window["army" + map.getZoom()],
                zIndexOffset: armies_zindex,
                contextmenu: true,
                contextmenuInheritItems: false,
                contextmenuItems: [{
                    text: 'hadsereg mozgatása',
                    disabled: false,
                    callback: selectArmy,
                }]
            }).addTo(map)
                .on('click', onMapClick);

            if (typeof data[i].army != 'undefined') {
                //army_marker.options.contextmenuItems[0].disabled = false;

                army_marker.army = data[i].army;

                if (army_marker.army.task_id > 0) {
                    army_marker.options.contextmenuItems[0].disabled = true;
                }
            }

            army_markers.addLayer(army_marker);
        }
    });

}


function onMapClick(e) {
    map.contextmenu.hide();
    map.closePopup();
    var coord = calculateHexCoord(e.latlng);
    placeHighlightHex(coord.x, coord.y);
    getHexData(coord.x, coord.y);
    started_path_group.clearLayers();

}

function calculateHexCoord(latlng) {
    // calculate clicked hex coordinates ==================================================
    var x = (rc.project(latlng).x - margin_x - (HEX_HEIGHT / 2)) / (HEX_HEIGHT * 0.75);
    var y = (rc.project(latlng).y - margin_y - (HEX_HEIGHT / 2)) / HEX_HEIGHT;
    var z = -0.5 * x - y;
    var y = -0.5 * x + y;

    ix = Math.floor(x + 0.5);
    iy = Math.floor(y + 0.5);
    iz = Math.floor(z + 0.5);
    s = ix + iy + iz;
    if (s) {
        abs_dx = Math.abs(ix - x);
        abs_dy = Math.abs(iy - y);
        abs_dz = Math.abs(iz - z);
        if (abs_dx >= abs_dy && abs_dx >= abs_dz) {
            ix -= s;
        } else if (abs_dy >= abs_dx && abs_dy >= abs_dz) {
            iy -= s;
        } else {
            iz -= s;
        }
    }

    // map_x and map_y are the map coordinates of the click
    map_x = ix;
    map_y = (iy - iz + (1 - ix % 2 ) ) / 2 - 0.5;

    return {x: map_x, y: map_y};
}

function placeHighlightHex(x, y) {
    if (x < 0 || y < 0 || x > 39 || y > 39) {
        return false;
    }

    // --- Calculate coordinates of this hex.  We will use this
    // --- to place the highlight image.
    tx = (x * HEX_SIDE * 1.5) + 36;
    ty = (y * HEX_SCALED_HEIGHT + (x % 2) * HEX_SCALED_HEIGHT / 2) + 36;

    if (typeof highlightMarker != 'undefined') {
        highlightMarker.setLatLng(rc.unproject([tx + margin_x, ty + margin_y]));
        //map.removeLayer(highlightMarker);
    } else {
        highlightMarker = L.marker(rc.unproject([tx + margin_x, ty + margin_y]), {
            icon: window["highlight" + map.getZoom()],
            zIndexOffset: highlight_zindex,
            clickable: false,
        }).addTo(map);
    }
}

function getHexData(x, y) {
    // ajax hex info ================================================================
    if (x < 0 || y < 0 || x > 39 || y > 39) {
        return false;
    }
    $.getJSON("/map/get_hex_data", {x: x, y: y}, function (data) {
        switch (data.city_nation) {
            case 0:
                var city_nation = '';
                break;
            case 1:
                var city_nation = 'római';
                break;
            case 2:
                var city_nation = 'görög';
                break;
            case 3:
                var city_nation = 'germán';
                break;
            case 4:
                var city_nation = 'szarmata';
                break;
        }

        switch (data.army_nation) {
            case 0:
                var army_nation = '';
                break;
            case 1:
                var army_nation = 'római';
                break;
            case 2:
                var army_nation = 'görög';
                break;
            case 3:
                var army_nation = 'germán';
                break;
            case 4:
                var army_nation = 'szarmata';
                break;
        }

        switch (data.layer1) {
            case 1:
                var type = 'mély víz';
                break;
            case 2:
                var type = 'homokos part';
                break;
            case 3:
                var type = 'füves rét';
                break;
            case 4:
                var type = 'fenyőerdő';
                break;
            case 5:
                var type = 'hómező';
                break;
            case 6:
                var type = 'dombvidék';
                break;
            case 7:
                var type = 'havas dombok';
                break;
            case 8:
                var type = 'hegy';
                break;
            case 9:
                var type = 'sekély víz';
                break;
            case 10:
                var type = 'jég';
                break;
            case 11:
                var type = 'mocsár';
                break;
        }

        info.update({
            x: x,
            y: y,
            type: type,
            hex_owner: data.owner,

            city_owner: data.city_owner,
            city_name: data.city_name,
            city_nation: city_nation,

            army_id: data.army_id,
            army_owner: data.army_owner,
            army_nation: army_nation,
            army: data.army
        });

        if (typeof data.path != 'undefined') {
            var started_path = [{x: x, y: y}];
            started_path = started_path.concat(data.path);
            drawPath(started_path, started_path_group);

            army_markers.eachLayer(function (marker) {
                if (marker.army.id == data.army_id) {


                    marker.army = data;
                    marker.unbindPopup();

                    if (typeof data.path_time != 'undefined') {
                        marker.options.contextmenuItems[0].disabled = true;

                        marker.bindPopup(
                            "hátralévő idő: <span id='countdown'></span>",
                            {offset: new L.Point(0, -30)}).openPopup();

                    } else {
                        marker.options.contextmenuItems[0].disabled = false;

                    }
                }
            });

            $('#countdown').countdown(data.path_time, function (event) {
                $(this).html(event.strftime('%H:%M:%S'));
            });
        }

    });
}


function selectArmy(e) {
    path_markers.clearLayers();
    point_markers.clearLayers();

    if (typeof highlightMarker != 'undefined') {
        map.removeLayer(highlightMarker);
        highlightMarker = undefined;
    }
    armycoord = calculateHexCoord(e.latlng);

    points = [];
    path = [];

    points.push(armycoord);

    map.contextmenu.setDisabled(0, false);

    // --- Calculate coordinates of this hex.  We will use this
    // --- to place the highlight image.
    tx = (armycoord.x * HEX_SIDE * 1.5) + 36;
    ty = (armycoord.y * HEX_SCALED_HEIGHT + (armycoord.x % 2) * HEX_SCALED_HEIGHT / 2) + 36;

    if (typeof highlightMarkerFrom != 'undefined') {
        highlightMarkerFrom.setLatLng(rc.unproject([tx + margin_x, ty + margin_y]));
        //map.removeLayer(highlightMarker);
    } else {
        highlightMarkerFrom = L.marker(rc.unproject([tx + margin_x, ty + margin_y]), {
            icon: window["highlight" + map.getZoom()],
            zIndexOffset: 2000,
            clickable: false
        }).addTo(map);
    }
}

function addPathPoint(e) {
    var coord = calculateHexCoord(e.latlng);
    points.push(coord);

    path_markers.clearLayers();
    point_markers.clearLayers();

    path = [];

    if (typeof highlightMarker != 'undefined') {
        map.removeLayer(highlightMarker);
        highlightMarker = undefined;
    }
    createPath();
    drawPathPoints();
    drawPath(path, path_markers);
    calculatePathTime(e.latlng);
}


function createPath() {
    var l = points.length;
    for (var i = 0; i < l - 1; i++) {
        var a = offsetToCube(points[i]);
        var b = offsetToCube(points[i + 1]);
        path = path.concat(calculateLine(a, b));
    }
}

function drawPathPoints() {
    l = points.length;
    for (var i = 1; i < l; i++) {
        tx = (points[i].x * HEX_SIDE * 1.5) + 36;
        ty = (points[i].y * HEX_SCALED_HEIGHT + (points[i].x % 2) * HEX_SCALED_HEIGHT / 2) + 36;

        pointMarker = L.marker(rc.unproject([tx + margin_x, ty + margin_y]), {
            number: i,
            icon: window["green" + map.getZoom()],
            zIndexOffset: path_point_zindex,
            clickable: true,
            draggable: true,
            contextmenu: true,
            contextmenuInheritItems: false,
            context: this,
            contextmenuItems: [{
                disabled: false,
                text: 'pont törlése',
                callback: deletePathPoint
            }]
        })
            .addTo(map)
            .on('drag', dragPathPoint)
            .on('contextmenu', function (e) {
                point_marker_number = e.target.options.number;
            })
            .on('click', onMapClick);

        pointMarker
            .bindPopup("út hossza: " + path.length + " hex", {offset: new L.Point(0, -30)})
            .on('dragend', function (e) {
                calculatePathTime(e.target._latlng);

        });

        pointMarker.openPopup();

        point_markers.addLayer(pointMarker);
    }

}

function drawPath(path, layerGroup) {
    l = path.length;
    for (var i = 0; i < l; i++) {
        tx = (path[i].x * HEX_SIDE * 1.5) + 36;
        ty = (path[i].y * HEX_SCALED_HEIGHT + (path[i].x % 2) * HEX_SCALED_HEIGHT / 2) + 36;

        var pathMarker = L.marker(rc.unproject([tx + margin_x, ty + margin_y]), {
            number: i,
            icon: window["brush" + map.getZoom()],
            zIndexOffset: path_zindex,
            clickable: true,
            contextmenu: true,
            contextmenuInheritItems: false,
            contextmenuItems: []
        }).addTo(map);
        layerGroup.addLayer(pathMarker)
    }

}


function dragPathPoint(e) {
    if (typeof highlightMarker != 'undefined') {
        map.removeLayer(highlightMarker);
        highlightMarker = undefined;
    }

    var coord = calculateHexCoord(e.target._latlng);

    tx = (coord.x * HEX_SIDE * 1.5) + 36;
    ty = (coord.y * HEX_SCALED_HEIGHT + (coord.x % 2) * HEX_SCALED_HEIGHT / 2) + 36;

    e.target.setLatLng(rc.unproject([tx + margin_x, ty + margin_y]));

    points[e.target.options.number] = coord;

    path = [];

    path_markers.clearLayers();


    createPath();
    drawPath(path, path_markers);
}

function deletePathPoint() {
    points.splice(point_marker_number, 1);
    path = [];

    path_markers.clearLayers();
    point_markers.clearLayers();

    if (typeof highlightMarker != 'undefined') {
        map.removeLayer(highlightMarker);
        highlightMarker = undefined;
    }

    createPath();
    drawPath(path, path_markers);
    drawPathPoints();
}


function calculatePathTime(e) {
    var coord = calculateHexCoord(e);
    path.push(coord);

    $.post("/map/path_price", {'_token': $('meta[name=_token]').attr('content'), path: path}, function (data) {
        var sec_num = parseInt(data, 10);
        var hours = Math.floor(sec_num / 3600);
        var minutes = Math.floor((sec_num - (hours * 3600)) / 60);
        var seconds = sec_num - (hours * 3600) - (minutes * 60);

        if (hours < 10) {
            hours = "0" + hours;
        }
        if (minutes < 10) {
            minutes = "0" + minutes;
        }
        if (seconds < 10) {
            seconds = "0" + seconds;
        }
        var time = hours + ':' + minutes + ':' + seconds;
        point_markers.eachLayer(function (layer) {
            layer._popup.setContent(
                "út hossza: " + (parseInt(path.length, 10) - 1) + " hex<br>" +
                "út ideje: " + time + "<br>" +
                '<button type="button" class="btn btn-xs btn-success" onclick="moveToHex(path)">mehet</button> '
            );
        });
    });

    pointMarker.openPopup();
}

function moveToHex(path) {
    $.post("/map/move_army", {_token: $('meta[name=_token]').attr('content'), path: path}, function (data) {
        map.contextmenu.setDisabled(0, true);
        path_markers.clearLayers();
        point_markers.clearLayers();
        points = [];
        path = [];
        army_markers.eachLayer(function (marker) {
            if (marker.army.id == data) {
                marker.unbindPopup();
                console.log(marker);
                marker.options.contextmenuItems[0].disabled = true;
            }
        });

    });
    map.closePopup();
}


//window.setInterval(function(){
//    army_markers.clearLayers();
//
//    getArmies();
//
//
//}, 10000);








